include mixin_ratingtocolor.pug

include function_calcCoeficient.pug

mixin Rating(friendsOnly, suggestion, user)
    - var coeficient = 0;
    - var defaultCoeficient = 2.5;
    - var sum = defaultCoeficient;
    - var rating = defaultCoeficient*5;
    - for (var id in suggestion.userRating){
        if (suggestion.userRating.hasOwnProperty(id))
            //p 
            //p
            //p OwnID: #{user._id} , ID: #{id}
            //| Name: #{infosys.usernames[id]} , rating: #{suggestion.userRating[id]} , Coeficient:
            - coeficient = 0;
            if (user.correlation[id] && (friendsOnly && user.friendlist.indexOf(id) > -1 || !friendsOnly) ) 
                if ( user.correlation[id][suggestion.category] && user.correlation[id][suggestion.category].ratingSum )
                    //- coeficient = Number((user.correlation[id][suggestion.category].ratingSum + 5) /(user.correlation[id][suggestion.category].ratingCount + 1))
                    //| Normal Coeficient: #{coeficient}
                    - coeficient = CalcCoeficient(user.correlation[id][suggestion.category])
                    //| Mixin Coeficient: #{coeficient}
                else
                    - coeficient = defaultCoeficient;
                    //| #{coeficient}
            else if (!friendsOnly /*&& user._id != id*/)
                - coeficient = defaultCoeficient;
                //| #{coeficient}
            else
                //| #{coeficient}
            //| #{rating}
            - rating += coeficient*suggestion.userRating[id]
            - sum += coeficient;
    -}
    if (sum != defaultCoeficient)
        - var result = Number((rating)/(sum)).toFixed(2)
        td(data-order= result )
            //p #{sum}
            //p #{rating}
            +RatingToColor(result)
        //| #{}
    else
        td(data-sort= "#")
            | #
    //p rating: #{rating}
    //p Sum: #{sum}